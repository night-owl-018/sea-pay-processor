<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ATGSD Sea Pay Processor</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    h1 { margin: 0 0 12px 0; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { border: 1px solid #ccc; border-radius: 8px; padding: 12px; min-width: 320px; flex: 1; }
    .btn { padding: 8px 12px; cursor: pointer; }
    .muted { color: #666; }
    .status { font-weight: bold; }
    .bar { height: 12px; border: 1px solid #999; border-radius: 999px; overflow: hidden; }
    .bar > div { height: 100%; width: 0%; background: #2b78ff; transition: width 150ms linear; }
    pre { background: #0b0b0b; color: #e6e6e6; padding: 10px; border-radius: 8px; max-height: 360px; overflow: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 6px; vertical-align: top; }
    th { background: #f5f5f5; }
    input[type="text"] { width: 100%; box-sizing: border-box; }
    select { width: 100%; }
  </style>
</head>
<body>
  <h1>ATGSD Sea Pay Processor</h1>

  <div class="row">
    <div class="card">
      <h2>Upload & Process</h2>
      <input id="fileInput" type="file" multiple accept=".pdf" />
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
        <button class="btn" id="btnProcess">Process</button>
        <button class="btn" id="btnClearLogs">Clear Logs</button>
      </div>

      <div style="margin-top:12px;">
        <div class="status" id="statusText">Status: Idle</div>
        <div class="muted" id="statusDetail"></div>
        <div style="margin-top:8px;" class="bar"><div id="progressBar"></div></div>
      </div>
    </div>

    <div class="card">
      <h2>Live Log</h2>
      <pre id="liveLog">(waiting...)</pre>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <h2>Review & Override</h2>

    <div class="row">
      <div style="min-width:320px;flex:0 0 320px;">
        <label class="muted">Member</label>
        <select id="memberSelect"></select>
        <div style="margin-top:10px;display:flex;gap:8px;">
          <button class="btn" id="btnLoadSheets">Load Sheets</button>
          <button class="btn" id="btnSaveSheets">Save Changes</button>
        </div>
        <div class="muted" style="margin-top:8px;" id="reviewHint"></div>
      </div>

      <div style="flex:1;min-width:420px;">
        <div id="sheetsContainer" class="muted">No sheets loaded.</div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  async function jget(url) {
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  async function jpost(url, bodyObj) {
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(bodyObj)
    });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  async function postForm(url, formData) {
    const r = await fetch(url, { method: "POST", body: formData });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  // ----- Progress + Live Log -----
  function renderProgress(p) {
    const status = p.status || "idle";
    const percent = (p.percent ?? 0);

    $("statusText").textContent = `Status: ${status.toUpperCase()} (${percent}%)`;
    $("progressBar").style.width = `${Math.max(0, Math.min(100, percent))}%`;

    const total = p.total_files ?? 0;
    const done = p.done_files ?? 0;
    const msg = p.message || "";
    const err = p.error ? ` | ERROR: ${p.error}` : "";
    $("statusDetail").textContent = total ? `${msg} (${done}/${total})${err}` : `${msg}${err}`;

    if (Array.isArray(p.lines)) {
      $("liveLog").textContent = p.lines.join("\n") || "(no logs yet)";
      // auto-scroll
      $("liveLog").scrollTop = $("liveLog").scrollHeight;
    }
  }

  async function pollProgress() {
    try {
      const p = await jget("/progress");
      renderProgress(p);
    } catch (e) {
      $("statusText").textContent = "Status: ERROR";
      $("statusDetail").textContent = String(e);
    }
  }

  setInterval(pollProgress, 500);
  pollProgress();

  $("btnClearLogs").addEventListener("click", async () => {
    await fetch("/logs/clear", { method: "POST" });
    pollProgress();
  });

  $("btnProcess").addEventListener("click", async () => {
    const files = $("fileInput").files;
    if (!files || files.length === 0) {
      alert("Select PDFs first.");
      return;
    }
    const fd = new FormData();
    for (const f of files) fd.append("files", f);
    await postForm("/process", fd);
    pollProgress();
  });

  // ----- Review & Override -----
  let CURRENT_MEMBER = "";
  let CURRENT_SHEETS = [];

  async function loadMembers() {
    $("memberSelect").innerHTML = "";
    const data = await jget("/api/members");
    const members = data.members || [];
    if (members.length === 0) {
      $("memberSelect").innerHTML = `<option value="">(no members found yet)</option>`;
      $("reviewHint").textContent = "Run processing first so SEA_PAY_REVIEW.json exists.";
      return;
    }
    $("reviewHint").textContent = "Select a member, Load Sheets, edit fields, then Save Changes.";
    for (const m of members) {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      $("memberSelect").appendChild(opt);
    }
    CURRENT_MEMBER = $("memberSelect").value;
  }

  function normalizeSheets(sheets) {
    // sheets can be:
    // - list of objects
    // - list of rows
    // We keep it as-is but ensure array.
    if (!Array.isArray(sheets)) return [];
    return sheets;
  }

  function renderSheets() {
    const c = $("sheetsContainer");
    if (!CURRENT_SHEETS || CURRENT_SHEETS.length === 0) {
      c.textContent = "No sheets for this member.";
      return;
    }

    // Render a simple editable table for each sheet
    c.innerHTML = "";
    CURRENT_SHEETS.forEach((sheet, sheetIdx) => {
      const wrap = document.createElement("div");
      wrap.style.marginBottom = "14px";

      const title = document.createElement("div");
      title.style.fontWeight = "bold";
      title.style.marginBottom = "6px";

      const sheetName =
        sheet.sheet_name || sheet.filename || sheet.title || sheet.sheet || `Sheet ${sheetIdx + 1}`;
      title.textContent = sheetName;

      wrap.appendChild(title);

      const rows = sheet.rows || sheet.items || sheet.data || sheet.entries || [];
      if (!Array.isArray(rows) || rows.length === 0) {
        const p = document.createElement("div");
        p.className = "muted";
        p.textContent = "No rows found in this sheet object.";
        wrap.appendChild(p);
        c.appendChild(wrap);
        return;
      }

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th style="width:120px;">Date</th>
          <th>Event / Ship</th>
          <th style="width:120px;">Status</th>
          <th style="width:240px;">Reason</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      rows.forEach((r, rowIdx) => {
        const dateVal = r.date || r.event_date || r.day || "";
        const eventVal = r.event || r.ship || r.description || "";
        const statusVal = (r.status || (r.valid === true ? "valid" : (r.valid === false ? "invalid" : ""))) || "";
        const reasonVal = r.reason || r.invalid_reason || "";

        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td><input type="text" data-sheet="${sheetIdx}" data-row="${rowIdx}" data-field="date" value="${escapeHtml(String(dateVal))}"></td>
          <td><input type="text" data-sheet="${sheetIdx}" data-row="${rowIdx}" data-field="event" value="${escapeHtml(String(eventVal))}"></td>
          <td>
            <select data-sheet="${sheetIdx}" data-row="${rowIdx}" data-field="status">
              <option value=""></option>
              <option value="valid">valid</option>
              <option value="invalid">invalid</option>
            </select>
          </td>
          <td><input type="text" data-sheet="${sheetIdx}" data-row="${rowIdx}" data-field="reason" value="${escapeHtml(String(reasonVal))}"></td>
        `;

        tbody.appendChild(tr);

        // Set select after insert
        const sel = tr.querySelector('select[data-field="status"]');
        if (sel) sel.value = String(statusVal).toLowerCase();
      });

      table.appendChild(tbody);
      wrap.appendChild(table);
      c.appendChild(wrap);
    });
  }

  function escapeHtml(s) {
    return s.replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
  }

  function applyEditsToSheets() {
    const inputs = document.querySelectorAll("#sheetsContainer input, #sheetsContainer select");
    for (const el of inputs) {
      const sheetIdx = parseInt(el.getAttribute("data-sheet"), 10);
      const rowIdx = parseInt(el.getAttribute("data-row"), 10);
      const field = el.getAttribute("data-field");

      const sheet = CURRENT_SHEETS[sheetIdx];
      if (!sheet) continue;

      const rows = sheet.rows || sheet.items || sheet.data || sheet.entries;
      if (!Array.isArray(rows) || !rows[rowIdx]) continue;

      const row = rows[rowIdx];
      const val = el.value;

      if (field === "date") row.date = val;
      if (field === "event") row.event = val;
      if (field === "status") {
        // keep both 'status' and boolean 'valid' if your pipeline expects either
        row.status = val;
        if (val === "valid") row.valid = true;
        else if (val === "invalid") row.valid = false;
      }
      if (field === "reason") {
        row.reason = val;
        row.invalid_reason = val; // keep both forms
      }
    }
  }

  $("btnLoadSheets").addEventListener("click", async () => {
    const member = $("memberSelect").value;
    if (!member) return;

    CURRENT_MEMBER = member;

    const data = await jget(`/api/sheets?member=${encodeURIComponent(member)}`);
    CURRENT_SHEETS = normalizeSheets(data.sheets || []);
    renderSheets();
  });

  $("btnSaveSheets").addEventListener("click", async () => {
    if (!CURRENT_MEMBER) {
      alert("Pick a member first.");
      return;
    }
    applyEditsToSheets();

    await jpost("/api/sheets/save", {
      member: CURRENT_MEMBER,
      sheets: CURRENT_SHEETS
    });

    alert("Saved to SEA_PAY_REVIEW.json");
  });

  $("memberSelect").addEventListener("change", () => {
    CURRENT_MEMBER = $("memberSelect").value;
  });

  loadMembers().catch(() => {});
</script>
</body>
</html>
